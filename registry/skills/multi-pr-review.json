{
  "id": "multi-pr-review",
  "name": "multi-pr-review",
  "description": "Run a consensus-style multi-agent review of a PR with severity-based findings.",
  "icon": "ðŸ”Ž",
  "category": "Development",
  "prompt": "# multi-pr-review\n\nBundled upstream source: https://github.com/dyad-sh/dyad/tree/main/.claude/skills/multi-pr-review\n\n# Multi-Agent PR Review\n\nThis skill creates three independent sub-agents to review code changes, then aggregates their findings using consensus voting.\n\n## Overview\n\n1. Fetch PR diff files and existing comments\n2. Spawn 3 sub-agents, each receiving files in different randomized order\n   - **Agent 1**: Code Health focus (maintainability, clarity, abstractions)\n   - **Agents 2-3**: Default focus (correctness, bugs, security)\n3. Each agent reviews and classifies issues (high/medium/low criticality)\n4. Aggregate results: report issues where 2+ agents agree\n5. Filter out issues already commented on (deduplication)\n6. Post findings: summary table + inline comments for HIGH/MEDIUM issues\n\n## Workflow\n\n### Step 1: Fetch PR Diff\n\n```bash\n# Get changed files from PR\ngh pr diff <PR_NUMBER> --repo <OWNER/REPO> > pr_diff.patch\n\n# Or get list of changed files\ngh pr view <PR_NUMBER> --repo <OWNER/REPO> --json files -q '.files[].path'\n```\n\n### Step 2: Run Multi-Agent Review\n\nExecute the orchestrator script:\n\n```bash\npython3 {baseDir}/scripts/orchestrate_review.py \\\n  --pr-number <PR_NUMBER> \\\n  --repo <OWNER/REPO> \\\n  --diff-file pr_diff.patch\n```\n\nThe orchestrator:\n\n1. Parses the diff into individual file changes\n2. Creates 3 shuffled orderings of the files\n3. Spawns 3 parallel sub-agent API calls\n4. Collects and aggregates results\n\n### Step 3: Review Prompt Templates\n\nSub-agents receive role-specific prompts (see `{baseDir}/references/review_prompt_default.md`):\n\n**Agent 1 (Code Health):**\n\n- Focuses on maintainability, code clarity, abstractions, debugging ease\n- Rates sloppy code that hurts maintainability as MEDIUM severity\n\n**Agents 2-3 (Default):**\n\n- Focus on correctness, bugs, security, edge cases\n- Also flag significant maintainability issues as MEDIUM\n\n```\nSeverity levels:\nHIGH: Security vulnerabilities, data loss risks, crashes, broken functionality\nMEDIUM: Logic errors, edge cases, performance issues, AND sloppy code that\n        significantly hurts maintainability (confusing logic, poor abstractions)\nLOW: Minor style issues, nitpicks, minor improvements\n\nOutput JSON array of issues.\n```\n\n### Step 4: Consensus Aggregation & Deduplication\n\nIssues are matched across agents by file + approximate line range + issue type. An issue is reported only if:\n\n- 2+ agents identified it AND\n- At least one agent rated it MEDIUM or higher\n\n**Deduplication:** Before posting, the script fetches existing PR comments and filters out issues that have already been commented on (matching by file, line, and issue keywords). This prevents duplicate comments when re-running the review.\n\n### Step 5: Post PR Comments\n\nThe script posts two types of comments:\n\n1. **Summary comment**: Overview table with issue counts (always posted, even if no new issues)\n2. **Inline comments**: Detailed feedback on specific lines (HIGH/MEDIUM only)\n\n```bash\npython3 {baseDir}/scripts/post_comment.py \\\n  --pr-number <PR_NUMBER> \\\n  --repo <OWNER/REPO> \\\n  --results consensus_results.json\n```\n\nOptions:\n\n- `--dry-run`: Preview comments without posting\n- `--summary-only`: Only post summary, skip inline comments\n\n#### Example Summary Comment\n\n```markdown\n## :mag: Multi-Agent Code Review\n\nFound **4** new issue(s) flagged by 3 independent reviewers.\n(2 issue(s) skipped - already commented)\n\n### Summary\n\n| Severity               | Count |\n| ---------------------- | ----- |\n| :red_circle: HIGH      | 1     |\n| :yellow_circle: MEDIUM | 2     |\n| :green_circle: LOW     | 1     |\n\n### Issues to Address\n\n| Severity               | File                     | Issue                                    |\n| ---------------------- | ------------------------ | ---------------------------------------- |\n| :red_circle: HIGH      | `src/auth/login.ts:45`   | SQL injection in user lookup             |\n| :yellow_circle: MEDIUM | `src/utils/cache.ts:112` | Missing error handling for Redis failure |\n| :yellow_circle: MEDIUM | `src/api/handler.ts:89`  | Confusing control flow - hard to debug   |\n\n<details>\n<summary>:green_circle: Low Priority Issues (1 items)</summary>\n\n- **Inconsistent naming convention** - `src/utils/helpers.ts:23`\n\n</details>\n\nSee inline comments for details.\n\n_Generated by multi-agent consensus review_\n```\n\n## File Structure\n\n```\nscripts/\n  orchestrate_review.py  - Main orchestrator, spawns sub-agents\n  aggregate_results.py   - Consensus voting logic\n  post_comment.py        - Posts findings to GitHub PR\nreferences/\n  review_prompt_default.md    - Default reviewer prompt\n  review_prompt_code_health.md - Code-health reviewer prompt\n  issue_schema.md        - JSON schema for issue output\n```\n\n## Configuration\n\nEnvironment variables:\n\n- `GITHUB_TOKEN` - Required for PR access and commenting\n\nNote: `ANTHROPIC_API_KEY` is **not required** - sub-agents spawned via the Task tool automatically have access to Anthropic.\n\nOptional tuning in `{baseDir}/scripts/orchestrate_review.py`:\n\n- `NUM_AGENTS` - Number of sub-agents (default: 3)\n- `CONSENSUS_THRESHOLD` - Min agents to agree (default: 2)\n- `MIN_SEVERITY` - Minimum severity to report (default: MEDIUM)\n- `THINKING_BUDGET_TOKENS` - Extended thinking budget (default: 128000)\n- `MAX_TOKENS` - Maximum output tokens (default: 128000)\n\n## Extended Thinking\n\nThis skill uses **extended thinking (interleaved thinking)** with **max effort** by default. Each sub-agent leverages Claude's extended thinking capability for deeper code analysis:\n\n- **Budget**: 128,000 thinking tokens per agent for thorough reasoning\n- **Max output**: 128,000 tokens for comprehensive issue reports\n\nTo disable extended thinking (faster but less thorough):\n\n```bash\npython3 {baseDir}/scripts/orchestrate_review.py \\\n  --pr-number <PR_NUMBER> \\\n  --repo <OWNER/REPO> \\\n  --diff-file pr_diff.patch \\\n  --no-thinking\n```\n\nTo customize thinking budget:\n\n```bash\npython3 {baseDir}/scripts/orchestrate_review.py \\\n  --pr-number <PR_NUMBER> \\\n  --repo <OWNER/REPO> \\\n  --diff-file pr_diff.patch \\\n  --thinking-budget 50000\n```",
  "parameters": [],
  "enabled": true,
  "metadata": {
    "version": "1.0.0",
    "author": "dyad-sh",
    "repository": "https://github.com/dyad-sh/dyad/tree/main/.claude/skills/multi-pr-review",
    "routing": {
      "useWhen": "Use when the user asks to run a consensus-style multi-agent review of a PR with severity-based findings.",
      "dontUseWhen": "Do not use when the request is asking for planning documents, high-level strategy, or non-executable discussion; use the relevant planning or design workflow instead.",
      "outputs": "Outcome from multi-pr-review: task-specific result plus concrete action notes.",
      "successCriteria": "Returns concrete actions and decisions matching the requested task, with no fabricated tool-side behavior."
    }
  }
}
